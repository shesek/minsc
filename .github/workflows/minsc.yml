name: Tests

on:
  push:
    branches: [ master, dev ]
  pull_request:
    branches: [ master ]

jobs:
  Test:
    runs-on: ubuntu-22.04
    env:
      CARGO_TERM_COLOR: always

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ—„ï¸ Cache
      uses: actions/cache@v4
      with:
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target

    - name: ğŸ› Check for errors
      run: cargo check --all-features

    - name: ğŸ§¹ Check formatting
      run: cargo fmt -- --check

    - name: ğŸ“ Check with Clippy
      run: cargo clippy --all-targets --all-features

    - name: ğŸ”¨ Build
      run: cargo build --release

    - name: ğŸ§ª Run tests
      run: MINSC_EXE=target/release/minsc ./tests/test.sh

    - name: ğŸ“– Run examples
      run: MINSC_EXE=target/release/minsc ./tests/test.sh examples

    - name: ğŸ“¦ Prepare artifacts
      run: strip target/release/minsc

    - name: ğŸ“¤ï¸ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: minsc
        path: target/release/minsc
