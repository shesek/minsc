test("Transaction", |T| {
  test("SigHash", |T| {
    // Test vectors from https://github.com/bitcoin/bips/blob/master/bip-0143.mediawiki#p2sh-p2wpkh
    test("Native P2WPKH", |T| {
      assert::eq(
        tx::sighash(
          0x0100000002fff7f7881a8099afa6940d42d1e7f6362bec38171ea3edf433541db4e4ad969f0000000000eeffffffef51e1b804cc89d182d279655c3aa89e815b1b309fe287d9b2b55d57b90ec68a0100000000ffffffff02202cb206000000001976a9148280b37df378db99f66f85c95a783a76ac7a6d5988ac9093510d000000001976a9143bde42dbee7e4dbe6a21b2d50ce2f0167faa815988ac11000000,
          1,
          [``:0, wpkh(025476c2e83188368da1ff3e292e7acafcdb3566bb0ad253f62fc70f07aeee6357):6 BTC],
          SIGHASH_ALL
        ),
        0xc37af31116d1b27caf68aae9e3ac82f1477929014d5b917657d0eb49478cb670
      )
    });

    test("P2SH-P2WPKH", |T| {
      assert::eq(
        tx::sighash(
          0x0100000001db6b1b20aa0fd7b23880be2ecbd4a98130974cf4748fb66092ac4d3ceb1a54770100000000feffffff02b8b4eb0b000000001976a914a457b684d7f0d539a46a45bbc043f35b59d0d96388ac0008af2f000000001976a914fd270b1ee6abcaea97fea7ad0402e8bd8ad6d77c88ac92040000,
          0,
          [sh(wpkh(03ad1d8e89212f0b92c74d23bb710c00662ad1470198ac48c43f7d6f93a2a26873)):10 BTC],
          SIGHASH_ALL
        ),
        0x64f3b0f4dd2bb3aa1ce8566d220cc74dda9df97d8490cc81d89d735c92e59fb6
      )
    });
  });

  test("Signing", |T| {
    $tx_unsigned = tx [
      "input": af53f2762ca3fdee7c24a4de710d38e585ccabc7b86e35104b3f5c180a012eb7:0,
      "outputs": [
        bcrt1q69g8t98h6ed787k607jasngpwk3q4xyp3prtxe:0.05 BTC,
        bcrt1q4sggfwqnj4ane33u9ps9egch47s26d4unvtvw2:0.049 BTC,
      ]
    ];

    $sk = cMzLdeGd5vEqxB8B6VFQoRopQ3sLAAvEzDAoQgvX54xwofSWj1fx;
    $sighash = tx::sighash($tx_unsigned, 0, [ wpkh($sk):0.1 BTC ], SIGHASH_ALL);
    $signature = ecdsa::sign($sk, $sighash) + SIGHASH_ALL;

    $tx_signed = tx::with_witness($tx_unsigned, [
      0: [ $signature, pubkey($sk) ],
    ]);

    assert::eq($tx_signed, tx(0x02000000000101b72e010a185c3f4b10356eb8c7abcc85e5380d71dea4247ceefda32c76f253af0000000000ffffffff02404b4c0000000000160014d1507594f7d65be3fada7fa5d84d0175a20a9881a0c44a0000000000160014ac1084b813957b3cc63c28605ca317afa0ad36bc02483045022100ba3985d59985214916cc6d5fe80293ce2915c478d280c5f7fa2994052171e968022028083fa1a4eb1972dcfb9f628505d71dd6e2c5e41c3133595eb4ef4c85ffe464012102d0de0aaeaefad02b8bdc8a01a1b8b11c696bd3d66a2c5f10780d95b7df42645c00000000));
  });
})